name: Build qt Bottle (DEPLOYMENT_TARGET macOS 12)

on:
  push:                       # å½“ push åˆ°ä»“åº“æ—¶è§¦å‘
  schedule:                   # å®šæ—¶ä»»åŠ¡ï¼ˆæ¯å‘¨ä¸€ UTC 03:00ï¼‰
    - cron: '0 3 * * 1'
  workflow_dispatch:           # æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write   # å¿…é¡»ï¼šå…è®¸åˆ›å»º/æ›´æ–° Release

jobs:
  build-macos-bottle:
    runs-on: macos-14
    env:
      HOMEBREW_DEVELOPER: "1"
    steps:
      # æ‹‰å–å½“å‰ repoï¼Œç”¨äºè¯»å–è¡¥ä¸å’Œè„šæœ¬
      - name: Checkout repo (for scripts/patches)
        uses: actions/checkout@v4

      # ç¼“å­˜ Homebrew ä¸‹è½½çš„ä¾èµ–ï¼ŒåŠ é€Ÿé‡å¤æ„å»º
      - name: Cache Homebrew downloads
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Caches/Homebrew
            ~/Library/Caches/Homebrew/downloads
          key: brew-cache-${{ runner.os }}-${{ hashFiles('patches/*.patch') }}
          restore-keys: |
            brew-cache-${{ runner.os }}-

      # ç¼“å­˜ ccacheï¼ˆç¼–è¯‘ç¼“å­˜ï¼‰ï¼Œè¿›ä¸€æ­¥åŠ é€Ÿé‡å¤æ„å»º
      - name: Cache ccache
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: ccache-${{ runner.os }}-${{ hashFiles('patches/*.patch') }}
          restore-keys: |
            ccache-${{ runner.os }}-

      - name: Prepare and build bottle (patch formula & bottle)
        run: |
          set -euxo pipefail

          FORMULA=qt
          RBFILE="${FORMULA}.rb"
          WORKDIR="$GITHUB_WORKSPACE/build"
          ARTDIR="$GITHUB_WORKSPACE/artifacts"
          mkdir -p "$WORKDIR" "$ARTDIR"
          cd "$WORKDIR"

          # ğŸ”§ ä¿®å¤ macOS ä¸Šçš„ libpng/mono å†²çªé—®é¢˜
          curl -kOs https://gist.githubusercontent.com/nicerobot/1515915/raw/uninstall-mono.sh
          chmod +x ./uninstall-mono.sh
          ./uninstall-mono.sh

          # ä» Homebrew å®˜æ–¹ä»“åº“è·å– formula
          curl -fsSLO "https://raw.githubusercontent.com/Homebrew/homebrew-core/main/Formula/${FORMULA:0:1}/${RBFILE}"

          # åº”ç”¨è‡ªå®šä¹‰è¡¥ä¸
          cp "$GITHUB_WORKSPACE/patches/${FORMULA}.patch" .
          patch "${RBFILE}" < "${FORMULA}.patch"

          # âš¡ å¯ç”¨ ccacheï¼ŒåŠ é€Ÿç¼–è¯‘
          brew install ccache
          export PATH="/usr/local/opt/ccache/libexec:$PATH"

          # ç§»é™¤ cmakeï¼Œé¿å…ä¾èµ–å†²çª
          brew uninstall --ignore-dependencies cmake

          # ç¼–è¯‘å¹¶ç”Ÿæˆ bottle
          brew install --build-bottle  --formula "./${RBFILE}"
          brew bottle "${FORMULA}" --skip-relocation

          # ç§»åŠ¨ç»“æœæ–‡ä»¶åˆ° artifacts
          mv ./*.tar.gz "$ARTDIR/"

      # ä¸Šä¼  bottle æ–‡ä»¶ä½œä¸ºæ„å»ºäº§ç‰©
      - name: Upload bottle artifact
        uses: actions/upload-artifact@v4
        with:
          name: qt-macos-bottle
          path: artifacts/*.tar.gz

      # åˆ›å»º/æ›´æ–° nightly Releaseï¼Œå¹¶é™„åŠ  bottle æ–‡ä»¶
      - name: Create/Update GitHub Release 'nightly' and attach bottle
        if: always()
        uses: softprops/action-gh-release@v2
        with:
          tag_name: nightly
          name: Nightly bottle
          files: artifacts/*.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
