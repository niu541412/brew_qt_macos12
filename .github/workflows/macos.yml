# This is a basic workflow to help you get started with Actions

name: Build qt Bottle for macOS 12 (patch official formula)

# Controls when the workflow will run
on:
  schedule:
    - cron: '0 3 * * 1'   # 每周一 UTC 03:00（按需改）

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  build-macos-bottle:
    runs-on: macos-latest
    env:
      HOMEBREW_DEVELOPER: "1"
    steps:
      - name: Checkout repo (for scripts/patches)
        uses: actions/checkout@v4

      - name: Prepare and build bottle (patch formula & bottle)
        run: |
          set -euxo pipefail

          FORMULA=qt
          RBFILE="${FORMULA}.rb"
          WORKDIR="$GITHUB_WORKSPACE/build"
          ARTDIR="$GITHUB_WORKSPACE/artifacts"
          mkdir -p "$WORKDIR" "$ARTDIR"
          cd "$WORKDIR"

          # libpng version mismatch issue, https://stackoverflow.com/questions/36523911#answer-68936263
          curl -kOs https://gist.githubusercontent.com/nicerobot/1515915/raw/uninstall-mono.sh
          chmod +x ./uninstall-mono.sh
          ./uninstall-mono.sh

          curl -fsSLO "https://raw.githubusercontent.com/Homebrew/homebrew-core/main/Formula/q/qt.rb"

          cp "$GITHUB_WORKSPACE/patches/${FORMULA}.patch" .
          patch "${RBFILE}" < "${FORMULA}.patch"

          brew update
          brew uninstall cmake
          brew install --build-from-source --formula ./${RBFILE}
          # brew install --build-bottle "./${RBFILE}"

          # 生成 bottle 文件（tar.gz），--skip-relocation 可视情况使用
          brew bottle "${FORMULA}" --skip-relocation

          # 把 bottle 移到 artifacts 目录
          mv ./*.tar.gz "$ARTDIR/"

          # （可选）导出 bottle 的 JSON，然后写回 formula（--write 会 write bottle DSL 回公式）
          # brew bottle --json "${FORMULA}" > bottle.json
          # brew bottle --write bottle.json

      - name: Upload bottle artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${ { github.repository } }-${{ matrix.os || 'macos' }}-bottle
          path: artifacts/*.tar.gz

      - name: Create/Update GitHub Release 'nightly' and attach bottle
        if: always()
        uses: softprops/action-gh-release@v2
        with:
          tag_name: nightly
          name: Nightly bottle
          files: artifacts/*.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}